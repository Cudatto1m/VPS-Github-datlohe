name: üöÄ VPS Windows with RDP + Ngrok

on:
  workflow_dispatch:   # Ch·∫°y th·ªß c√¥ng t·ª´ tab Actions

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360   # VPS ch·∫°y t·ªëi ƒëa 6h

    steps:
    - name: üîß Setup Windows RDP
      run: |
        # B·∫≠t Remote Desktop
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1

        # T·∫°o user m·ªõi
        net user datlohe Dat@123456 /add
        net localgroup administrators datlohe /add

        Write-Host "‚úÖ User: datlohe / Password: Dat@123456"

    - name: üåç C√†i Ngrok
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath .
        ./ngrok config add-authtoken $Env:NGROK_AUTH_TOKEN

        # M·ªü tunnel RDP (port 3389)
        Start-Process -FilePath "./ngrok.exe" -ArgumentList "tcp 3389" -NoNewWindow

        Start-Sleep -Seconds 15

        $tunnelInfo = Invoke-RestMethod -Uri http://127.0.0.1:4040/api/tunnels
        $publicUrl = $tunnelInfo.tunnels[0].public_url

        Write-Host "============================"
        Write-Host "‚úÖ K·∫æT N·ªêI VPS QUA RDP:"
        Write-Host "üëâ $publicUrl"
        Write-Host "============================"
