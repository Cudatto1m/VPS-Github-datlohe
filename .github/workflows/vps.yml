name: 🚀 VPS Windows with Cloudflare Tunnel

on:
  workflow_dispatch:   # Chạy thủ công

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360   # VPS chạy tối đa 6h

    steps:
    - name: 🔧 Setup Windows RDP
      run: |
        # Bật Remote Desktop
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1

        # Tạo user
        net user datlohe Dat@123456 /add
        net localgroup administrators datlohe /add
        Write-Host "✅ User: datlohe / Password: Dat@123456"

    - name: 🌍 Cài đặt Cloudflared
      run: |
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        .\cloudflared.exe --version

    - name: 🚪 Tạo Named Tunnel
      run: |
        mkdir $env:USERPROFILE\.cloudflared
        echo "tunnel: vps-tunnel" > $env:USERPROFILE\.cloudflared\config.yml
        echo "credentials-file: $env:USERPROFILE\.cloudflared\vps-tunnel.json" >> $env:USERPROFILE\.cloudflared\config.yml
        echo "ingress:" >> $env:USERPROFILE\.cloudflared\config.yml
        echo "  - service: tcp://localhost:3389" >> $env:USERPROFILE\.cloudflared\config.yml
        echo "  - service: http_status:404" >> $env:USERPROFILE\.cloudflared\config.yml

        .\cloudflared.exe tunnel login
        .\cloudflared.exe tunnel create vps-tunnel
        .\cloudflared.exe tunnel route dns vps-tunnel vps.$Env:CF_API_EMAIL
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel run vps-tunnel"

    env:
      CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
      CF_API_KEY: ${{ secrets.CF_API_KEY }}
